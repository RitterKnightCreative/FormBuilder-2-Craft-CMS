{% extends "_layouts/cp" %}
{# Maybe delete bellow? #}
{% import "_includes/forms" as forms %}
{% import "formbuilder2/_includes/_components" as components %}
{% hook 'formBuilder2.prepCpTemplate' %}

{% set selectedSubnavItem = "forms" %}
{% set bodyClass = 'formbuilder fb-edit-form' %}
{% set pageSlug = craft.request.lastSegment %}

{% if pageSlug == 'edit' %}
    {% set page = 'Edit Form' %}
{% else %}
    {% set page = 'New Form' %}
{% endif %}

{% block pageHeader %}
    {% include 'formbuilder2/_includes/_header' ignore missing with { title: page } %}
{% endblock %}

{% block saveButton %}

{% endblock %}

{% block main %}

    <input type="hidden" name="action" value="formBuilder2/form/saveForm">
    <input type="hidden" name="redirect" value="formbuilder2/forms">

    {% if form.id %}
        <input type="hidden" name="formId" value="{{ form.id }}">
        <input type="hidden" name="fieldLayoutId" value="{{ form.fieldLayoutId }}">
    {% endif %}

    {% set availableFields = form.getFieldLayout().getFields() %}
    {% set fieldsOption = [] %}
    {% set fieldsOption = [{label: 'Select Field', value: ''}] %}
    {% for field in availableFields %}
        {% set fieldItem = field.getField(field) %}
        {% if fieldItem.type == 'PlainText' %}
            {% set fieldsOption = fieldsOption|merge([{ label: fieldItem.name, value: fieldItem.handle }]) %}
        {% endif %}
    {% endfor %}

    {% set errors = form.getErrors() %}
    {% set templates = craft.formBuilder2.getTemplates() %}
    {% set templateOption = [{label: 'Select Template', value: ''}] %}
    {% for template in templates %}
        {% set templateOption = templateOption|merge([{ label: template.name, value: template.handle }]) %}
    {% endfor %}
    
    <div class="grid first" data-max-cols="3">

        <div class="item" data-position="left" data-colspan="2">
            {% include 'formbuilder2/forms/_includes/fields' ignore missing with { theme: 'moss' } %}
            {% include 'formbuilder2/forms/_includes/messages' ignore missing with { theme: 'moss' } %}
            {% include 'formbuilder2/forms/_includes/admin-notification' ignore missing with { theme: 'moss' } %}
            {% include 'formbuilder2/forms/_includes/submitter-notification' ignore missing with { theme: 'moss' } %}
        </div>

        <div class="editform-sidebar item" data-position="right">
            <section class="form-settings-tout cmp-tout theme-white">
                <header>
                    <span class="tout-title">{{ "Form Settings" |t }}</span>
                </header>
                <div class="body">
                    {% include 'formbuilder2/forms/_includes/settings/basic-settings' ignore missing %}
                </div>
            </section>

            <section class="form-options-tout cmp-tout theme-white">
                <header>
                    <span class="tout-title">{{ "Database" |t }}</span>
                </header>
                <div class="body">
                    {% include 'formbuilder2/forms/_includes/settings/save-entries' ignore missing %}
                </div>
            </section>

            <section class="form-options-tout cmp-tout theme-white">
                <header>
                    <span class="tout-title">{{ "Form Options" |t }}</span>
                </header>
                <div class="body">
                    {% include 'formbuilder2/forms/_includes/options/submit-button' ignore missing %}
                    {% include 'formbuilder2/forms/_includes/options/redirect' ignore missing %}
                    {% include 'formbuilder2/forms/_includes/options/ajax' ignore missing %}
                    {% include 'formbuilder2/forms/_includes/options/terms-conditions' ignore missing %}
                </div>
            </section>
            
            <section class="spam-protection-tout cmp-tout theme-white">
                <header>
                    <span class="tout-title">{{ "Spam Protection" |t }}</span>
                </header>
                <div class="body">
                    {% include 'formbuilder2/forms/_includes/spam/honeypot' ignore missing %}
                    {% include 'formbuilder2/forms/_includes/spam/timed' ignore missing %}
                </div>
            </section>

            <div class="pane meta save-form-meta last">
                <button type="submit" href="#" class="btns btn-info save-form">{{ "Save Form" |t }}</button>
            </div>

            {% if form.id %}
                <div class="pane meta delete-form-meta last">
                    <a href="#" class="btns btn-danger delete-form" data-id="{{ form.id }}">{{ "Delete Form" |t }}</a>
                </div>
            {% endif %}
        </div>

    </div>

{% endblock %}

{% includeJsResource "formbuilder2/js/forms.js" %}
{% includeJsResource "formbuilder2/js/option.js" %}
{% includeJsResource "formbuilder2/js/modal.js" %}
{% includeJsResource "formbuilder2/js/fields.js" %}
{% includeJsResource "formbuilder2/js/tags.js" %}

{% includejs %}
    $('.section-collapsible').each(function(i,el){
        new FormBuilderSection(el);
    });

    {% if not form.handle %}new Craft.HandleGenerator('#formName', '#formHandle');{% endif %}
{% endincludejs %}